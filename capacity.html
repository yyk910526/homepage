<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电容器充放电实验</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding: 5px; 
            background-color: #f0f8ff; 
        }
        .title-container { 
            display: flex; 
            justify-content: center; 
            align-items: baseline; 
            margin-bottom: 2px;
        }
        h1 { margin: 0; color: #272626; }
        .designer { 
            font-size: 20px; 
            color: #2401e9; 
            margin-left: 20px; 
            font-family: 'Brush Script MT', cursive; 
            font-style: italic; 
        }
        #controls-and-labels-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            padding: 0 10px;
            gap: 50px;
        }
        #controls-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-wrap: wrap;
        }
        #data-labels-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            min-width: 300px;   /* 标签数字的宽度 */
            gap: 10px;
        }
        .value-label { 
            font-size: 24px; 
            font-weight: bold; 
            width: 200px;
            text-align: left;
        }
        #current-label {
            color: rgb(0, 0, 255); /* 蓝色 */
        }
        #voltage-label {
            color: rgb(255, 0, 0); /* 红色 */
        }
        .chart-container { 
            width: 100%; 
            max-width: 1200px; 
            height: 255px;
            margin: -5px auto;
            position: relative;
        }
        #auto-scale-button {
            position: absolute;
            left: 10px;
            bottom: 1px;
            font-size: 9px;
            padding: 2px;
            z-index: 10;
        }
        button { 
            margin: 5px; 
            padding: 10px 15px; 
            font-size: 17px; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
        }
        button:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
        }
        button:hover:not(:disabled) { 
            background-color: #45a049; 
        }
    </style>
</head>
<body>
    <div class="title-container">
        <h1>电容器充放电实验</h1>
        <span class="designer">杨燕琨老师设计</span>
    </div>
    <div id="controls-and-labels-container">
        <div id="controls-container">
            <button id="connect-button">扫描并连接</button>
            <button id="start-button" disabled>开始采集</button>
            <button id="stop-button" disabled>停止采集</button>
            <button id="clear-button" disabled>删除数据</button>
            <button id="save-button" disabled>保存数据</button>
        </div>
        <div id="data-labels-container">
            <div id="current-label" class="value-label">电流: 0.000 mA</div>
            <div id="voltage-label" class="value-label">电压: 0.000 V</div>
        </div>
    </div>
    <div class="chart-container">
        <canvas id="currentChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="voltageChart"></canvas>
    </div>

    <script>
        let device, characteristic, server;
        let currentChart, voltageChart;
        let isCollecting = false;
        let isConnected = false;
        let startTime = 0;
        const maxDataPoints = 500;
        let timeData = [];
        let currentData = [];
        let voltageData = [];

        const connectButton = document.getElementById('connect-button');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const clearButton = document.getElementById('clear-button');
        const saveButton = document.getElementById('save-button');
        const currentLabel = document.getElementById('current-label');
        const voltageLabel = document.getElementById('voltage-label');

        function createChart(ctx, label, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: color,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: '时间 (s)',
                                font: { size: 16 }
                            },
                            ticks: {
                                callback: value => value.toFixed(1),
                                font: { size: 14 }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: label,
                                font: { size: 16 }
                            },
                            ticks: {
                                font: { size: 14 }
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'xy',
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                            }
                        },
                        legend: {
                            display: true, // 两个图表都显示图例
                            position: 'top',
                            align: 'end'
                        }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        function initCharts() {
            currentChart = createChart(
                document.getElementById('currentChart').getContext('2d'),
                '电流 (mA)',
                'rgb(0, 0, 255)' // 蓝色
            );
            voltageChart = createChart(
                document.getElementById('voltageChart').getContext('2d'),
                '电压 (V)',
                'rgb(255, 0, 0)' // 红色
            );
        }

        let lastAxisUpdateTime = 0;  // 添加一个变量记录上次更新轴的时间

        function updateCharts(current, voltage) {
            const currentTime = (Date.now() - startTime) / 1000;
            timeData.push(currentTime);
            currentData.push(current);
            voltageData.push(voltage);

            // 当数据点超过最大值时,移除最早的数据点
            if (timeData.length > maxDataPoints) {
                timeData.shift();
                currentData.shift();
                voltageData.shift();

                // 更新坐标轴范围,使图表连续滚动
                const timeMin = timeData[0];
                const timeMax = timeData[timeData.length - 1];
                
                currentChart.options.scales.x.min = timeMin;
                currentChart.options.scales.x.max = timeMax;
                voltageChart.options.scales.x.min = timeMin;
                voltageChart.options.scales.x.max = timeMax;
            }

            // 更新电流图表 (显示为mA)
            currentChart.data.datasets[0].data = currentData.map((value, index) => ({
                x: timeData[index],
                y: value * 1000 // 转换为mA
            }));

            // 更新电压图表
            voltageChart.data.datasets[0].data = voltageData.map((value, index) => ({
                x: timeData[index],
                y: value
            }));

            // 更新图表显示
            currentChart.update('none'); // 使用 'none' 模式避免动画
            voltageChart.update('none');

            // 更新标签显示
            currentLabel.textContent = `电流: ${(current * 1000).toFixed(3)} mA`;
            voltageLabel.textContent = `电压: ${voltage.toFixed(3)} V`;

            saveButton.disabled = false;
        }

        async function connectDevice() {
            try {
                // 如果已经连接，先断开
                if (isConnected) {
                    await disconnectDevice();
                }

                // 检查蓝牙可用性
                if ('bluetooth' in navigator && 'getAvailability' in navigator.bluetooth) {
                    const isBluetoothAvailable = await navigator.bluetooth.getAvailability();
                    if (!isBluetoothAvailable) {
                        throw new Error('蓝牙不可用');
                    }
                }

                // 请求设备连接
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'yykdislab' }],
                    optionalServices: ['cddf1001-30f7-4671-8b43-5e40ba53514a']
                });

                // 连接到设备
                server = await device.gatt.connect();
                const service = await server.getPrimaryService('cddf1001-30f7-4671-8b43-5e40ba53514a');
                characteristic = await service.getCharacteristic('cddf1002-30f7-4671-8b43-5e40ba53514a');

                // 设置通知
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);

                // 添加断开连接监听器
                device.addEventListener('gattserverdisconnected', onDisconnected);

                // 更新状态和UI
                isConnected = true;
                connectButton.textContent = '断开连接';
                updateButtonStates();
                
                // 初始化图表
                if (!currentChart || !voltageChart) {
                    initCharts();
                }

            } catch (error) {
                console.error('连接错误:', error);
                // 发生错误时确保完全断开
                await disconnectDevice();
                alert('连接失败，请重试');
            }
        }

        function handleData(event) {
            const value = event.target.value;
            const dataView = new DataView(value.buffer);
            
            const rawCurrent = dataView.getFloat32(0, true);
            const current = rawCurrent / 1000; // 转换电流单位
            const voltage = dataView.getFloat32(4, true);

            if (!isNaN(current) && !isNaN(voltage)) {
                if (isCollecting) {
                    updateCharts(current, voltage);
                }
            } else {
                console.log('数据格式错误：无法解析为数字');
            }
        }

        startButton.addEventListener('click', () => {
            isCollecting = true;
            startTime = Date.now();
            startButton.disabled = true;
            stopButton.disabled = false;
        });

        stopButton.addEventListener('click', () => {
            isCollecting = false;
            startButton.disabled = false;
            stopButton.disabled = true;
        });

        clearButton.addEventListener('click', () => {
            timeData = [];
            currentData = [];
            voltageData = [];
            startTime = 0;
            currentChart.data.datasets[0].data = [];
            voltageChart.data.datasets[0].data = [];
            currentChart.update();
            voltageChart.update();
            currentLabel.textContent = '电流: 0.000 mA';
            voltageLabel.textContent = '电压: 0.000 V';
            updateButtonStates();
        });

        function saveData() {
            if (timeData.length === 0) {
                alert('没有可保存的数据');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "时间 (s),电流 (mA),电压 (V)\n";

            for (let i = 0; i < timeData.length; i++) {
                csvContent += `${timeData[i]},${currentData[i]},${voltageData[i]}\n`;
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "current_voltage_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function disconnectDevice() {
            try {
                if (characteristic) {
                    await characteristic.stopNotifications();
                }
                if (device && device.gatt.connected) {
                    await device.gatt.disconnect();
                }
            } catch (error) {
                console.error('断开连接错误:', error);
            } finally {
                // 无论如何都调用 onDisconnected 确保状态重置
                onDisconnected();
            }
        }

        function onDisconnected() {
            console.log('设备已断开连接');
            
            // 重置所有状态
            isConnected = false;
            isCollecting = false;
            
            // 清除设备相关变量
            device = null;
            server = null;
            characteristic = null;
            
            // 重置数据
            timeData = [];
            currentData = [];
            voltageData = [];
            startTime = 0;
            
            // 重置UI
            connectButton.textContent = '扫描并连接';
            currentLabel.textContent = '电流: 0.000 mA';
            voltageLabel.textContent = '电压: 0.000 V';
            
            // 重置图表
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            if (voltageChart) {
                voltageChart.destroy();
                voltageChart = null;
            }
            
            // 重新初始化图表
            initCharts();
            
            // 更新按钮状态
            updateButtonStates();
        }

        function updateButtonStates() {
            startButton.disabled = !isConnected;
            stopButton.disabled = !isConnected || !isCollecting;
            clearButton.disabled = !isConnected;
            saveButton.disabled = !isConnected || timeData.length === 0;
            isCollecting = false;
        }

        connectButton.addEventListener('click', async () => {
            if (!isConnected) {
                await connectDevice();
            } else {
                await disconnectDevice();
            }
        });

        saveButton.addEventListener('click', saveData);

        // 添加自动缩放功能
        function addAutoScaleButton() {
            const button = document.createElement('button');
            button.id = 'auto-scale-button';
            button.textContent = '自动缩放';
            button.style.position = 'absolute';
            button.style.left = '10px';
            button.style.bottom = '1px';
            button.style.fontSize = '9px';
            button.style.padding = '2px';

            document.querySelector('.chart-container').appendChild(button);

            button.addEventListener('click', () => {
                autoScaleCharts();
            });
        }

        function autoScaleCharts() {
            if (timeData.length > 0) {
                // 自动缩放电流图表
                const currentValues = currentData.map(v => v * 1000); // 转换为mA
                const currentMin = Math.min(...currentValues);
                const currentMax = Math.max(...currentValues);
                const currentPadding = (currentMax - currentMin) * 0.1;

                currentChart.options.scales.y.min = currentMin - currentPadding;
                currentChart.options.scales.y.max = currentMax + currentPadding;

                // 自动缩放电压图表
                const voltageMin = Math.min(...voltageData);
                const voltageMax = Math.max(...voltageData);
                const voltagePadding = (voltageMax - voltageMin) * 0.1;

                voltageChart.options.scales.y.min = voltageMin - voltagePadding;
                voltageChart.options.scales.y.max = voltageMax + voltagePadding;

                // 自动缩放时间轴
                const timeMin = Math.min(...timeData);
                const timeMax = Math.max(...timeData);
                const timePadding = (timeMax - timeMin) * 0.1;

                currentChart.options.scales.x.min = timeMin - timePadding;
                currentChart.options.scales.x.max = timeMax + timePadding;
                voltageChart.options.scales.x.min = timeMin - timePadding;
                voltageChart.options.scales.x.max = timeMax + timePadding;

                currentChart.update();
                voltageChart.update();
            }
        }

        // 在初始化图表后添加自动缩放按钮
        initCharts();
        addAutoScaleButton();
    </script>
</body>
</html>
